name: Step2 Code Review

on:
  pull_request:
    types: [opened, synchronize]
  issue_comment:
    types: [created]

jobs:
  claude-review:
    if: |
      (github.event_name == 'pull_request' && (
        contains(github.event.pull_request.title, 'step2') ||
        contains(github.event.pull_request.title, 'Step2') ||
        contains(github.event.pull_request.title, '2ë‹¨ê³„') ||
        contains(github.event.pull_request.labels.*.name, 'step2')
      )) ||
      (github.event_name == 'issue_comment' && 
       github.event.issue.pull_request && 
       contains(github.event.comment.body, '@claude review'))

    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Generate GitHub App token
        id: app-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}

      - name: Configure AWS Credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ap-northeast-2

      - name: Run Claude Code Review
        id: claude-review
        uses: anthropics/claude-code-action@beta
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          use_bedrock: true
          timeout_minutes: '30'
          model: 'apac.anthropic.claude-sonnet-4-20250514-v1:0'

          # Direct prompt for automated review (no @claude mention needed)
          direct_prompt: |
            ## ğŸ¯ Step 2 ë¯¸ì…˜ ë‹¬ì„±ë„ ì¤‘ì‹¬ ë¦¬ë·° ê°€ì´ë“œë¼ì¸
            
            **ì´ ë¦¬ë·°ëŠ” Step 2 ë¯¸ì…˜ ìš”êµ¬ì‚¬í•­ ë‹¬ì„±ì— ì§‘ì¤‘í•©ë‹ˆë‹¤.**
            Legacy MVCì™€ @MVC í”„ë ˆì„ì›Œí¬ì˜ í†µí•© êµ¬í˜„ì„ ì¤‘ì ì ìœ¼ë¡œ ê²€í† í•˜ê³  **í•œê¸€ë¡œ** í”¼ë“œë°±ì„ ì œê³µí•´ì£¼ì„¸ìš”.
            
            ### ğŸ“š í•™ìŠµ ì›ì¹™
            - **ì§ì ‘ ì½”ë“œë¥¼ ì œê³µí•˜ì§€ ë§ˆì„¸ìš”** (í•™ìŠµìê°€ ëª…ì‹œì ìœ¼ë¡œ ìš”ì²­í•˜ëŠ” ê²½ìš° ì œì™¸)
            - **ë¬¸ì œ í•´ê²° ê³¼ì •ì„ ì•ˆë‚´**í•˜ë˜, ì •ë‹µì„ ë°”ë¡œ ì•Œë ¤ì£¼ì§€ ë§ˆì„¸ìš”
            - **ì‘ì€ ë‹¨ê³„ë¡œ ë¬¸ì œë¥¼ ë¶„í•´**í•˜ì—¬ ì ‘ê·¼í•˜ë„ë¡ ë„ì™€ì£¼ì„¸ìš”
            
            ### ğŸ’¡ í”¼ë“œë°± ë°©ë²•
            - **ìœ ë„ ì§ˆë¬¸ í™œìš©**: "ë§Œì•½ ~ë¼ë©´ ì–´ë–»ê²Œ ë ê¹Œìš”?", "~ë¥¼ ê³ ë ¤í•´ë³´ì…¨ë‚˜ìš”?"
            - **íŒíŠ¸ ì œê³µ**: ë°©í–¥ì€ ì œì‹œí•˜ë˜, êµ¬ì²´ì ì¸ êµ¬í˜„ì€ í•™ìŠµìê°€ í•˜ë„ë¡
            - **ë‹¤ì–‘í•œ ì ‘ê·¼ë²• ì œì‹œ**: í•œ ê°€ì§€ í•´ê²°ì±…ì´ ì•„ë‹Œ ì—¬ëŸ¬ ê°€ëŠ¥ì„±ì„ ì œì•ˆ
            - **ì™œ?ì— ì§‘ì¤‘**: ë‹¨ìˆœíˆ ë¬´ì—‡ì´ ì˜ëª»ë˜ì—ˆëŠ”ì§€ë³´ë‹¤ ì™œ ê·¸ëŸ°ì§€ ì´í•´í•˜ë„ë¡
            
            ### ğŸ” ë””ë²„ê¹… ë…ë¦½ì„± ê°•í™”
            - ì—ëŸ¬ ë©”ì‹œì§€ë¥¼ **ìŠ¤ìŠ¤ë¡œ ì½ê³  ì´í•´**í•˜ë„ë¡ ê²©ë ¤
            - ë¡œê·¸ í™œìš©ë²• ì•ˆë‚´ (System.out.println, logger, ë””ë²„ê±° í™œìš©)
            - ë¬¸ì œ íŒ¨í„´ íŒŒì•…ì„ ë„ì™€ **ë””ë²„ê¹… ìŠ¤í‚¬ í–¥ìƒ**
            - ê´€ë ¨ ë¬¸ì„œë‚˜ JavaDoc ì°¸ì¡° ê¶Œì¥
            
            ### ğŸ“‹ ë¯¸ì…˜ ë‹¬ì„±ë„ ì²´í¬ë¦¬ìŠ¤íŠ¸
            
            #### 1. HandlerMapping ì¸í„°í˜ì´ìŠ¤ ì¶”ìƒí™”
            - [ ] HandlerMapping ì¸í„°í˜ì´ìŠ¤ ì •ì˜ (getHandler ë©”ì„œë“œ)
            - [ ] ManualHandlerMappingê³¼ AnnotationHandlerMappingì´ ì¸í„°í˜ì´ìŠ¤ êµ¬í˜„
            - [ ] DispatcherServletì—ì„œ ë‘ HandlerMappingì„ Listë¡œ ê´€ë¦¬
            
            #### 2. ControllerScanner êµ¬í˜„
            - [ ] Reflections ë¼ì´ë¸ŒëŸ¬ë¦¬ë¡œ @Controller í´ë˜ìŠ¤ ìŠ¤ìº”
            - [ ] ìŠ¤ìº”ëœ í´ë˜ìŠ¤ë“¤ì˜ ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
            - [ ] @RequestMapping ë©”ì„œë“œ ì •ë³´ ì¶”ì¶œí•˜ì—¬ HandlerKey-HandlerExecution ë§¤í•‘
            
            #### 3. HandlerAdapter íŒ¨í„´ ì ìš©
            - [ ] HandlerAdapter ì¸í„°í˜ì´ìŠ¤ ì •ì˜
            - [ ] Controllerì™€ HandlerExecutionì„ ê°ê° ì²˜ë¦¬í•˜ëŠ” ì–´ëŒ‘í„° êµ¬í˜„
            - [ ] DispatcherServletì—ì„œ ì ì ˆí•œ ì–´ëŒ‘í„° ì„ íƒí•˜ì—¬ ì‹¤í–‰
            
            ### ğŸ“ í•µì‹¬ í•™ìŠµ í¬ì¸íŠ¸
            - **ì¸í„°í˜ì´ìŠ¤ ì¶”ìƒí™”**: ê³µí†µ ê¸°ëŠ¥ì„ ì¸í„°í˜ì´ìŠ¤ë¡œ ì¶”ìƒí™”í•˜ëŠ” ë°©ë²•
            - **ì–´ëŒ‘í„° íŒ¨í„´**: ì„œë¡œ ë‹¤ë¥¸ íƒ€ì…ì„ í†µí•© ì²˜ë¦¬í•˜ëŠ” íŒ¨í„´
            - **ë¦¬í”Œë ‰ì…˜**: ëŸ°íƒ€ì„ì— í´ë˜ìŠ¤ì™€ ë©”ì„œë“œ ì •ë³´ë¥¼ í™œìš©í•˜ëŠ” ë°©ë²•
            - **ë ˆê±°ì‹œì™€ ì‹ ê·œ ê¸°ìˆ ì˜ ê³µì¡´**: ê¸°ì¡´ ì½”ë“œë¥¼ ìœ ì§€í•˜ë©´ì„œ ìƒˆ ê¸°ëŠ¥ì„ ì¶”ê°€í•˜ëŠ” ì „ëµ
            - **í™•ì¥ ê°€ëŠ¥í•œ ì„¤ê³„**: Listë¥¼ í™œìš©í•œ ì—¬ëŸ¬ êµ¬í˜„ì²´ì˜ ê´€ë¦¬
            
            ### ğŸŒŸ í•™ìŠµ ì™„ë£Œ í›„
            - "ì´ë²ˆ êµ¬í˜„ì„ í†µí•´ ë¬´ì—‡ì„ ë°°ìš°ì…¨ë‚˜ìš”?" ê°™ì€ **íšŒê³  ì§ˆë¬¸**
            - ë¹„ìŠ·í•œ ë¬¸ì œë¥¼ ë§Œë‚¬ì„ ë•Œ ì ìš© ê°€ëŠ¥í•œ **íŒ¨í„´ ì¸ì‹**
            - ë‹¤ìŒ ë‹¨ê³„ í•™ìŠµì„ ìœ„í•œ **ì¶”ê°€ í•™ìŠµ ìë£Œ** ì œì•ˆ
            
            ### âš ï¸ ì˜ˆì™¸ ìƒí™©
            - í•™ìŠµìê°€ "ì½”ë“œë¥¼ ë³´ì—¬ì£¼ì„¸ìš”" ë“± **ëª…ì‹œì ìœ¼ë¡œ ìš”ì²­**ì‹œì—ë§Œ ì½”ë“œ ì œê³µ
            - ê°œë… ì„¤ëª… ìš”ì²­ì‹œ (ì˜ˆ: "ì„œë¸”ë¦¿ì´ ë­”ê°€ìš”?") **ëª…í™•í•˜ê³  ì§ì ‘ì ì¸ ì„¤ëª…** ì œê³µ
            
            **ë¦¬ë·°ëŠ” ê±´ì„¤ì ì´ê³  ê²©ë ¤í•˜ëŠ” í†¤ìœ¼ë¡œ ì‘ì„±í•˜ë©°, í•™ìŠµìì˜ ì„±ì¥ì„ ìµœìš°ì„ ìœ¼ë¡œ ê³ ë ¤í•´ì£¼ì„¸ìš”.**
